<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroke Analysis - NeuroBridge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Navigation Bar Styles */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-left {
            display: flex;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }

        .brand-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .brand-text {
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .nav-icons {
            display: flex;
            gap: 15px;
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-icon svg {
            width: 20px;
            height: 20px;
        }

        .analysis-container {
            max-width: 1200px;
            margin: 100px auto 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .analysis-header {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .analysis-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .analysis-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .analysis-content {
            padding: 40px;
        }

        .step-container {
            margin-bottom: 40px;
        }

        .step-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #2563eb;
            margin-bottom: 20px;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 5px;
        }

        .step-description {
            color: #6b7280;
            font-size: 14px;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 48px;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #374151;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .uploaded-file {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .uploaded-file.show {
            display: block;
        }

        .file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            background: #10b981;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-meta {
            color: #065f46;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 12px;
            opacity: 0.8;
        }

        .remove-file {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Analysis Section */
        .analysis-section {
            display: none;
        }

        .analysis-section.show {
            display: block;
        }

        .analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
        }

        .analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .processing {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .processing.show {
            display: block;
        }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .mri-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mri-panel {
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .mri-panel-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: center;
        }

        .mri-image-container {
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mri-image {
            max-width: 100%;
            max-height: 280px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .description-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #2563eb;
        }

        .description-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .description-text {
            color: #374151;
            line-height: 1.6;
        }

        /* Clinical Report */
        .clinical-report {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .report-header {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .report-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .report-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .report-content {
            padding: 30px;
        }

        .report-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .report-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-text {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .diagnosis-result {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .diagnosis-result.positive {
            background: #fecaca;
            border-color: #ef4444;
        }

        .diagnosis-result.negative {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .ai-disclaimer {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        /* Enhanced Clinical Report Styles */
        .section-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* Medical Recommendations Section - Professional Clinical Document Style */
        .recommendations-section {
            background: #ffffff;
            border: 2px solid #2c3e50;
            padding: 30px;
            margin: 25px 0;
            font-family: 'Times New Roman', serif;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        
        .recommendations-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px double #2c3e50;
        }
        
        .recommendations-header h3 {
            margin: 0;
            color: #1a1a1a;
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Times New Roman', serif;
        }
        
        .clinical-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 2px solid #34495e;
            padding: 8px 0;
            letter-spacing: 0.5px;
        }
        
        .subsection-header {
            font-size: 14px;
            font-weight: bold;
            color: #34495e;
            margin: 15px 0 10px 0;
            text-decoration: underline;
            font-style: italic;
        }
        
        .medication-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .medication-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .medication-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            vertical-align: top;
        }
        
        .medication-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .medication-dose {
            color: #666;
            font-style: italic;
        }
        
        .medication-indication {
            color: #555;
            font-size: 13px;
        }
        
        .exercise-phase {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 12px 0;
            border-left: 4px solid #28a745;
        }
        
        .phase-title {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .specialist-timing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #f39c12;
        }
        
        .timing-header {
            font-weight: bold;
            color: #856404;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .recommendation-list {
            margin: 8px 0;
            padding: 0;
            list-style: none;
        }
        
        .recommendation-item {
            margin: 6px 0;
            padding: 4px 0 4px 20px;
            position: relative;
            line-height: 1.4;
        }
        
        .recommendation-item:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: #3498db;
            font-weight: bold;
        }
        
        .priority-immediate {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            padding: 10px 15px;
            margin: 10px 0;
        }
        
        .priority-urgent {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin: 10px 0;
        }
        
        .priority-routine {
            background: #f0f9ff;
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin: 10px 0;
        }
        
        .additional-notes {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
            color: #495057;
        }

        .info-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }

        .info-value {
            font-weight: 500;
            color: #1e293b;
        }

        .highlight-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            padding: 25px;
        }

        .diagnosis-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .diagnosis-result {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border-radius: 12px;
            font-size: 16px;
        }

        .diagnosis-icon {
            font-size: 24px;
        }

        .diagnosis-text {
            flex: 1;
        }

        .diagnosis-status {
            display: block;
            margin-top: 5px;
            font-size: 18px;
            font-weight: 700;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #7c3aed;
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .confidence-high { color: #059669; }
        .confidence-medium { color: #d97706; }
        .confidence-low { color: #dc2626; }

        .severity-low, .severity-mild { color: #059669; }
        .severity-medium, .severity-moderate { color: #d97706; }
        .severity-high, .severity-severe { color: #dc2626; }
        .severity-critical { color: #991b1b; }

        .affected-regions {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }

        .regions-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .regions-list {
            color: #6b7280;
            line-height: 1.5;
        }

        .clinical-findings-content {
            background: #fefefe;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }

        .finding-header {
            font-weight: 700;
            color: #1e40af;
            margin: 15px 0 10px 0;
            font-size: 16px;
        }

        .finding-item {
            margin: 8px 0;
            padding: 8px 12px;
            background: #f1f5f9;
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
        }

        .finding-bullet {
            margin: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .finding-bullet::before {
            content: "‚Ä¢";
            color: #3b82f6;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .finding-text {
            margin: 10px 0;
            line-height: 1.6;
            color: #374151;
        }

        .recommendations-content {
            background: #fefefe;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .recommendations-header {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.2s ease;
        }

        .recommendations-header:hover {
            background: #f1f5f9;
        }

        .recommendations-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendations-toggle {
            font-size: 14px;
            color: #64748b;
            transition: transform 0.2s ease;
        }

        .recommendations-toggle.expanded {
            transform: rotate(180deg);
        }

        .recommendations-summary {
            font-size: 14px;
            color: #64748b;
            font-style: italic;
        }

        .recommendations-body {
            padding: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .recommendations-body.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            margin: 12px 0;
            padding: 12px;
            background: #f0f9ff;
            border-left: 3px solid #0ea5e9;
            border-radius: 6px;
        }

        .recommendation-bullet {
            color: #0ea5e9;
            font-weight: bold;
            margin-right: 10px;
            margin-top: 2px;
        }

        .recommendation-text {
            flex: 1;
            line-height: 1.5;
            color: #374151;
        }

        .tech-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .tech-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .tech-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }

        .tech-value {
            font-weight: 500;
            color: #1e293b;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .disclaimer-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer-text {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        .download-section {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .download-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .analysis-container {
                margin: 80px 10px 0 10px;
            }

            .analysis-content {
                padding: 20px;
            }

            .mri-display {
                grid-template-columns: 1fr;
            }

            .report-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <div class="brand">
                <span class="brand-icon">üß†</span>
                <span class="brand-text">NeuroBridge</span>
            </div>
        </div>
        <div class="nav-right">
            <div class="nav-icons">
                <div class="nav-icon" onclick="redirectToDashboard()" title="Dashboard">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </div>
                <div class="nav-icon" onclick="redirectToProfile()" title="Profile">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="nav-icon" onclick="logout()" title="Logout">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
            </div>
        </div>
    </nav>

    <div class="analysis-container">
        <div class="analysis-header">
            <h1>üß† AI Stroke Analysis</h1>
            <p>Advanced MRI-based stroke detection and segmentation using deep learning</p>
        </div>

        <div class="analysis-content">
            <!-- Step 1: Upload MRI -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-title">Step 1: Upload MRI Scan</div>
                    <div class="step-description">Upload your MRI scan in .nii.gz format for AI-powered stroke analysis</div>
                </div>

                <div class="upload-area" onclick="document.getElementById('mriFile').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click to select MRI file</div>
                    <div class="upload-subtext">Or drag and drop your .nii.gz file here</div>
                    <button class="upload-btn" type="button">Browse Files</button>
                </div>

                <input type="file" id="mriFile" class="file-input" accept=".nii.gz,.txt" onchange="handleFileUpload(event)">

                <div class="uploaded-file" id="uploadedFile">
                    <div class="file-info">
                        <div class="file-details">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-meta">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                            </div>
                        </div>
                        <button class="remove-file" onclick="removeFile()">Remove</button>
                    </div>
                </div>

                <div class="error-message" id="uploadError">
                    <strong>Upload Error:</strong> <span id="uploadErrorText"></span>
                </div>
            </div>

            <!-- Step 2: Analysis -->
            <div class="step-container analysis-section" id="analysisSection">
                <div class="step-header">
                    <div class="step-title">Step 2: AI Analysis</div>
                    <div class="step-description">Run advanced AI stroke detection and segmentation analysis</div>
                </div>

                <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">
                    üß† Analyze MRI for Stroke Detection
                </button>

                <div class="processing" id="processingIndicator">
                    <div class="spinner"></div>
                    <div><strong>AI Analysis in Progress...</strong></div>
                    <div style="margin-top: 10px; color: #6b7280;">
                        Running stroke segmentation model and generating clinical insights
                    </div>
                </div>
            </div>

            <!-- Step 3: Results -->
            <div class="step-container results-section" id="resultsSection">
                <div class="step-header">
                    <div class="step-title">Step 3: Analysis Results</div>
                    <div class="step-description">View AI-generated stroke analysis, segmentation overlay, and clinical report</div>
                </div>

                <!-- MRI Images Display -->
                <div class="mri-display">
                    <div class="mri-panel">
                        <div class="mri-panel-header">Original MRI Scan</div>
                        <div class="mri-image-container">
                            <img id="originalMRI" class="mri-image" alt="Original MRI Scan" style="display: none;">
                            <div id="originalPlaceholder">Original MRI will appear here</div>
                        </div>
                    </div>
                    <div class="mri-panel">
                        <div class="mri-panel-header">Stroke Segmentation Overlay</div>
                        <div class="mri-image-container">
                            <img id="overlayMRI" class="mri-image" alt="Stroke Segmentation" style="display: none;">
                            <div id="overlayPlaceholder">Stroke segmentation will appear here</div>
                        </div>
                    </div>
                </div>

                <!-- AI Description -->
                <div class="description-section">
                    <div class="description-title">
                        ü§ñ AI-Generated Analysis Description
                    </div>
                    <div class="description-text" id="aiDescription">
                        AI-generated description will appear here after analysis...
                    </div>
                </div>

                <!-- Clinical Report -->
                <div class="clinical-report">
                    <div class="report-header">
                        <div class="report-title">Clinical Analysis Report</div>
                        <div class="report-subtitle">AI-Powered Stroke Detection & Assessment</div>
                    </div>

                    <div class="report-content" id="clinicalReportContent">
                        <!-- Report content will be dynamically generated -->
                    </div>

                    <div class="ai-disclaimer">
                        <div class="disclaimer-title">
                            ‚ö†Ô∏è AI Disclaimer
                        </div>
                        <div class="disclaimer-text">
                            This analysis is generated by artificial intelligence and is intended for research and educational purposes only. 
                            It should not be used as a substitute for professional medical diagnosis, treatment, or advice. 
                            Always consult with qualified healthcare professionals for medical decisions. 
                            The AI system may produce false positives or miss subtle abnormalities that require expert medical interpretation.
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="download-btn" id="downloadBtn" onclick="downloadReport()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7,10 12,15 17,10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download Complete Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('access_token');
        let uploadedFileData = null;
        let analysisResults = null;

        // Check if user is logged in
        if (!token) {
            window.location.href = '/login';
        }

        // Test backend connectivity
        async function testBackendConnection() {
            try {
                console.log('Testing backend connection...');
                
                // First try a simple test without auth
                const simpleResponse = await fetch('/api/stroke-analysis/test');
                console.log('Simple test response status:', simpleResponse.status);
                
                if (simpleResponse.ok) {
                    const result = await simpleResponse.json();
                    console.log('Simple test successful:', result);
                } else {
                    console.error('Simple test failed:', simpleResponse.status);
                }
                
                // Then try with auth token
                const response = await fetch('/api/stroke-analysis/test', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Auth test response status:', response.status);
                
                if (response.status === 401) {
                    console.error('Token is invalid or expired');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/login';
                    return;
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Auth test successful:', result);
                } else {
                    console.error('Auth test failed:', response.status);
                }
            } catch (error) {
                console.error('Backend connection error:', error);
            }
        }

        // Navigation functions
        function redirectToDashboard() {
            window.location.href = '/dashboard';
        }

        function redirectToProfile() {
            window.location.href = '/profile';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_data');
                window.location.href = '/login';
            }
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type (allow .txt for testing)
            if (!(file.name.endsWith('.nii.gz') || file.name.endsWith('.txt'))) {
                showError('Please upload a valid .nii.gz file (or .txt for testing)');
                return;
            }

            // Validate file size (max 100MB)
            if (file.size > 100 * 1024 * 1024) {
                showError('File size too large. Please upload a file smaller than 100MB');
                return;
            }

            uploadedFileData = file;
            showUploadedFile(file);
            document.getElementById('analysisSection').classList.add('show');
            hideError();
        }

        function showUploadedFile(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('uploadedFile').classList.add('show');
        }

        function removeFile() {
            uploadedFileData = null;
            document.getElementById('uploadedFile').classList.remove('show');
            document.getElementById('analysisSection').classList.remove('show');
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('mriFile').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Analysis functions
        async function runAnalysis() {
            if (!uploadedFileData) {
                showError('Please upload an MRI file first');
                return;
            }

            try {
                console.log('Starting analysis...', { token: token ? 'Present' : 'Missing' });
                document.getElementById('analyzeBtn').disabled = true;
                document.getElementById('processingIndicator').classList.add('show');

                // Upload file first
                const formData = new FormData();
                formData.append('file', uploadedFileData);

                console.log('Attempting upload to:', '/api/stroke-analysis/upload');
                console.log('File details:', { name: uploadedFileData.name, size: uploadedFileData.size });

                const uploadResponse = await fetch('/api/stroke-analysis/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                console.log('Upload response status:', uploadResponse.status);
                console.log('Upload response headers:', [...uploadResponse.headers.entries()]);

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('Upload failed:', errorText);
                    throw new Error(`Failed to upload MRI file: ${uploadResponse.status} - ${errorText}`);
                }

                const uploadResult = await uploadResponse.json();
                console.log('Upload result:', uploadResult);

                // Run analysis
                console.log('Starting analysis with file_id:', uploadResult.file_id);
                const analysisResponse = await fetch('/api/stroke-analysis/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ file_id: uploadResult.file_id })
                });

                console.log('Analysis response status:', analysisResponse.status);

                if (!analysisResponse.ok) {
                    const errorText = await analysisResponse.text();
                    console.error('Analysis failed:', errorText);
                    throw new Error(`Analysis failed: ${analysisResponse.status} - ${errorText}`);
                }

                analysisResults = await analysisResponse.json();
                displayResults(analysisResults);

            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('processingIndicator').classList.remove('show');
            }
        }

        function displayResults(results) {
            // Show images
            if (results.original_image) {
                document.getElementById('originalMRI').src = results.original_image;
                document.getElementById('originalMRI').style.display = 'block';
                document.getElementById('originalPlaceholder').style.display = 'none';
            }

            if (results.overlay_image) {
                document.getElementById('overlayMRI').src = results.overlay_image;
                document.getElementById('overlayMRI').style.display = 'block';
                document.getElementById('overlayPlaceholder').style.display = 'none';
            }

            // Show AI description
            if (results.ai_description) {
                document.getElementById('aiDescription').textContent = results.ai_description;
            }

            // Generate clinical report
            generateClinicalReport(results);

            // Show results section
            document.getElementById('resultsSection').classList.add('show');
        }

        function generateClinicalReport(results) {
            const reportContent = document.getElementById('clinicalReportContent');
            
            // Helper function to format clinical findings into structured sections
            function formatClinicalFindings(findings) {
                if (!findings) return 'Detailed clinical findings will be generated based on the AI analysis results.';
                
                // Try to parse structured findings if they contain sections
                const sections = findings.split(/(?=\d+\.|\*\*|###|##)/);
                if (sections.length > 1) {
                    return sections.map(section => {
                        const trimmed = section.trim();
                        if (trimmed.startsWith('**') || trimmed.startsWith('##')) {
                            // Format as header
                            const header = trimmed.replace(/\*\*|##/g, '').trim();
                            return `<div class="finding-header">${header}</div>`;
                        } else if (/^\d+\./.test(trimmed)) {
                            // Format as numbered item
                            return `<div class="finding-item">${trimmed}</div>`;
                        } else if (trimmed.startsWith('-') || trimmed.startsWith('‚Ä¢')) {
                            // Format as bullet point
                            return `<div class="finding-bullet">${trimmed}</div>`;
                        } else {
                            return `<div class="finding-text">${trimmed}</div>`;
                        }
                    }).join('');
                }
                
                // Simple paragraph formatting for unstructured text
                return `<div class="finding-text">${findings}</div>`;
            }
            
            // Helper function to format recommendations into professional medical document style
            function formatRecommendations(recommendations) {
                if (!recommendations) return '<div class="additional-notes">Clinical recommendations will be provided based on the analysis results and patient profile.</div>';
                
                let formattedHTML = '';
                
                // Parse and structure the recommendations into medical document format
                const sections = {
                    medications: {
                        title: 'RECOMMENDED MEDICATIONS',
                        content: [],
                        subsections: {
                            primary: { title: 'Primary Therapy', items: [] },
                            secondary: { title: 'Secondary Prevention', items: [] },
                            acute: { title: 'Acute Management', items: [] }
                        }
                    },
                    rehabilitation: {
                        title: 'REHABILITATION EXERCISES',
                        content: [],
                        subsections: {
                            phase1: { title: 'Phase 1 - Acute Care (Days 1-3)', items: [] },
                            phase2: { title: 'Phase 2 - Subacute (Days 4-14)', items: [] },
                            phase3: { title: 'Phase 3 - Recovery (2-12 weeks)', items: [] },
                            longterm: { title: 'Long-term Exercise Program', items: [] }
                        }
                    },
                    specialists: {
                        title: 'SPECIALIST CONSULTATIONS REQUIRED',
                        content: [],
                        subsections: {
                            immediate: { title: 'Immediate Recommendations (Within 24 hours)', items: [] },
                            within48: { title: 'Within 48-72 hours', items: [] },
                            within1week: { title: 'Within 1 week', items: [] },
                            followup: { title: 'Follow-up Recommendations', items: [] }
                        }
                    },
                    additional: {
                        title: 'ADDITIONAL RECOMMENDATIONS',
                        content: [],
                        items: []
                    }
                };
                
                // Parse the recommendations text and categorize
                const lines = recommendations.split('\n').filter(line => line.trim());
                let currentSection = null;
                let currentSubsection = null;
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    // Detect section headers
                    if (line.toUpperCase().includes('MEDICATION') || line.toUpperCase().includes('THERAPY')) {
                        currentSection = 'medications';
                        currentSubsection = null;
                    } else if (line.toUpperCase().includes('REHABILITATION') || line.toUpperCase().includes('EXERCISE')) {
                        currentSection = 'rehabilitation';
                        currentSubsection = null;
                    } else if (line.toUpperCase().includes('SPECIALIST') || line.toUpperCase().includes('CONSULTATION')) {
                        currentSection = 'specialists';
                        currentSubsection = null;
                    } else if (line.toUpperCase().includes('ADDITIONAL')) {
                        currentSection = 'additional';
                        currentSubsection = null;
                    }
                    
                    // Detect subsection headers
                    if (line.includes('Primary Therapy') || line.includes('PRIMARY')) {
                        currentSubsection = 'primary';
                    } else if (line.includes('Secondary Prevention') || line.includes('SECONDARY')) {
                        currentSubsection = 'secondary';
                    } else if (line.includes('Acute Management') || line.includes('ACUTE')) {
                        currentSubsection = 'acute';
                    } else if (line.includes('Phase 1') || line.includes('Acute Care')) {
                        currentSubsection = 'phase1';
                    } else if (line.includes('Phase 2') || line.includes('Subacute')) {
                        currentSubsection = 'phase2';
                    } else if (line.includes('Phase 3') || line.includes('Recovery')) {
                        currentSubsection = 'phase3';
                    } else if (line.includes('Long-term') || line.includes('LONG-TERM')) {
                        currentSubsection = 'longterm';
                    } else if (line.includes('Within 24') || line.includes('Immediate')) {
                        currentSubsection = 'immediate';
                    } else if (line.includes('48-72') || line.includes('Within 48')) {
                        currentSubsection = 'within48';
                    } else if (line.includes('Within 1 week') || line.includes('1 week')) {
                        currentSubsection = 'within1week';
                    } else if (line.includes('Follow-up') || line.includes('FOLLOW-UP')) {
                        currentSubsection = 'followup';
                    }
                    
                    // Add content to appropriate section
                    if (line.startsWith('‚Ä¢') || line.startsWith('-') || line.match(/^\d+\./)) {
                        const cleanLine = line.replace(/^[‚Ä¢\-\d\.\s]+/, '').trim();
                        if (cleanLine && currentSection) {
                            if (currentSubsection && sections[currentSection].subsections && sections[currentSection].subsections[currentSubsection]) {
                                sections[currentSection].subsections[currentSubsection].items.push(cleanLine);
                            } else if (currentSection === 'additional') {
                                sections[currentSection].items.push(cleanLine);
                            } else {
                                sections[currentSection].content.push(cleanLine);
                            }
                        }
                    }
                });
                
                // Generate professional HTML
                Object.keys(sections).forEach(sectionKey => {
                    const section = sections[sectionKey];
                    if (section.content.length > 0 || Object.keys(section.subsections || {}).some(sub => section.subsections[sub].items.length > 0) || (section.items && section.items.length > 0)) {
                        formattedHTML += `<div class="clinical-section">`;
                        formattedHTML += `<div class="section-header">${section.title}</div>`;
                        
                        if (section.subsections) {
                            Object.keys(section.subsections).forEach(subKey => {
                                const subsection = section.subsections[subKey];
                                if (subsection.items.length > 0) {
                                    if (sectionKey === 'medications') {
                                        formattedHTML += `<div class="priority-immediate">`;
                                    } else if (sectionKey === 'rehabilitation') {
                                        formattedHTML += `<div class="exercise-phase">`;
                                    } else if (sectionKey === 'specialists') {
                                        formattedHTML += `<div class="specialist-timing">`;
                                    }
                                    
                                    formattedHTML += `<div class="${sectionKey === 'medications' ? 'medication-name' : sectionKey === 'rehabilitation' ? 'phase-title' : 'timing-header'}">${subsection.title}:</div>`;
                                    formattedHTML += `<ul class="recommendation-list">`;
                                    subsection.items.forEach(item => {
                                        formattedHTML += `<li class="recommendation-item">${item}</li>`;
                                    });
                                    formattedHTML += `</ul></div>`;
                                }
                            });
                        }
                        
                        if (section.items && section.items.length > 0) {
                            formattedHTML += `<div class="priority-routine">`;
                            formattedHTML += `<ul class="recommendation-list">`;
                            section.items.forEach(item => {
                                formattedHTML += `<li class="recommendation-item">${item}</li>`;
                            });
                            formattedHTML += `</ul></div>`;
                        }
                        
                        formattedHTML += `</div>`;
                    }
                });
                
                // If no structured content was found, format the raw text professionally
                if (!formattedHTML.trim()) {
                    formattedHTML = `<div class="additional-notes">${recommendations.replace(/\n/g, '<br>')}</div>`;
                }
                
                return formattedHTML;
            }
            
            const reportHTML = `
                <div class="report-section">
                    <div class="report-section-title">
                        <span class="section-icon">üë§</span>
                        Patient Information
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Patient ID:</span>
                            <span class="info-value">${results.patient_info?.id || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${results.patient_info?.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Age:</span>
                            <span class="info-value">${results.patient_info?.age || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gender:</span>
                            <span class="info-value">${results.patient_info?.gender || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Scan Date:</span>
                            <span class="info-value">${new Date().toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>

                <div class="report-section highlight-section">
                    <div class="report-section-title">
                        <span class="section-icon">üß†</span>
                        AI Analysis Results
                    </div>
                    <div class="diagnosis-container">
                        <div class="diagnosis-result ${results.stroke_detected ? 'positive' : 'negative'}">
                            <div class="diagnosis-icon">${results.stroke_detected ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                            <div class="diagnosis-text">
                                <strong>Stroke Detection:</strong>
                                <span class="diagnosis-status">${results.stroke_detected ? 'POSITIVE - Stroke lesions detected' : 'NEGATIVE - No stroke lesions detected'}</span>
                            </div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Confidence Score</div>
                                <div class="metric-value confidence-${results.confidence >= 80 ? 'high' : results.confidence >= 60 ? 'medium' : 'low'}">${results.confidence || 'N/A'}%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Lesion Volume</div>
                                <div class="metric-value">${results.lesion_volume || 'N/A'} mm¬≥</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Severity Level</div>
                                <div class="metric-value severity-${results.severity_level}">${results.severity_level || 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${results.affected_regions ? `
                        <div class="affected-regions">
                            <div class="regions-label">üéØ Affected Brain Regions:</div>
                            <div class="regions-list">${results.affected_regions}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-section-title">
                        <span class="section-icon">üîç</span>
                        Clinical Findings
                    </div>
                    <div class="clinical-findings-content">
                        ${formatClinicalFindings(results.clinical_findings)}
                    </div>
                </div>

                <div class="recommendations-section">
                    <div class="recommendations-header">
                        <h3>
                            <span class="section-icon">üíä</span>
                            Medical Recommendations
                        </h3>
                    </div>
                    <div class="recommendations-content">
                        ${formatRecommendations(results.recommendations)}
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        Technical Details
                    </div>
                    <div class="tech-details-grid">
                        <div class="tech-item">
                            <span class="tech-label">Model:</span>
                            <span class="tech-value">UNet Stroke Segmentation Model</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Processing Time:</span>
                            <span class="tech-value">${results.processing_time || 'N/A'} seconds</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Image Dimensions:</span>
                            <span class="tech-value">${results.image_dimensions || 'N/A'}</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Analysis ID:</span>
                            <span class="tech-value">${results.analysis_id || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;

            reportContent.innerHTML = reportHTML;
        }

        async function downloadReport() {
            if (!analysisResults) {
                showError('No analysis results to download');
                return;
            }

            try {
                const response = await fetch('/api/stroke-analysis/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        analysis_id: analysisResults.analysis_id,
                        analysis_results: analysisResults
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stroke_analysis_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('uploadErrorText').textContent = message;
            document.getElementById('uploadError').classList.add('show');
        }

        function hideError() {
            document.getElementById('uploadError').classList.remove('show');
        }

        // Drag and drop functionality
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('mriFile').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });
    </script>
</body>
</html>